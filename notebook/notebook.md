 # 进阶操作系统

## 第一课：进阶操作系统

- 什么是操作系统？
  - Windows, Linux, mac OS, Android, iOS, ...
  - 操作系统是直接运行于硬件之上的计算机程序
  - 操作系统用于管理和控制计算机的硬件与软件资源
  - 操作系统为用户软件的开发提供必要的服务和接口
- 现在计算机系统架构
  - 用户软件（编译软件）
  - 操作系统
  - BIOS（Basic Input Output System）
  - 硬件层
- BIOS-（Basic Input Output System）
  - BIOS 是计算机上电后的第一个运行程序
  - BIOS 首先检测硬件状态，检测通过后立即进行硬件初始化
  - BIOS 会在内存中建立终端向量表（提供硬件访问的方法）
  - BIOS 最后将控制权交由主引导程序执行
- BIOS不是软件（Software）而是固件（Firmware）
- 固件是固化于硬件中的程序，在硬件出厂前已经烧写固定了
- 系统启动流程
  - 上电->运行BIOS->硬件初始化
  - ->建立中断向量表->加载运行主引导程序->软件初始化
  - ->加载运行操作系统内核->系统初始化
- BIOS是如何被运行起来的？
  - BIOS 的运行机制
  - BIOS 存储于ROM中，地址映射为 0xF0000-0xFFFFF（实地址）
  - BIOS的入口地址为：0xFFFF0处开始执行
  - 硬件电路的特殊设计使得：开机后，CPU从0xFFFF0处开始执行
- BIOS最后的使命
  - 按照用户设置扫描各个存储介质（光驱，软驱，U盘）
  - 发现主引导区后，将主引导区中的主引导程序载入内存
  - 主引导程序在内存中的入口地址为0x7c00
  - 将控制权交由主引导程序执行（jmp 0x7c00）
- BIOS如何在存储介质中寻找主引导区？
- 如何判断引导区域中有没有主引导程序？
- 主引导区域（MBR：Master Boot Record）
  - 位置：位于存储介质的最开始的位置，大小为512字节
  - 特点：前512字节的最后两个有效字节为0x55aa
  - 数据：0x55aa之前的数据被视为主引导程序
- 小结
  - BIOS是计算机上电后的第一个运行的程序
  - BIOS进行必要的初始化，并加载运行主引导程序
  - 主引导程序位于存储介质的最开始512字节处
  - 主引导程序负责后续初始化，并加载运行操作系统内核

## 第二课：Hello, DTOS

- 问题：主引导程序是软件还是固件？

- 主引导程序

  - 一段存储在主引导区（MBR）中的有效代码
  - 并不固化于硬件，属于操作系统代码的一部分
  - 启动操作系统内核的桥梁，由汇编程序写成
  - 代码總量不能超过512字节（包含0x5aa）

- 主引导程序的开发

  - 入口：`0x7c00` -> 主引导程序（汇编语言）-> BIOS中断
  - 入口：`main` -> 应用程序（C/C++）-> OS系统调用

- 课程实验

  - 编写一个主引导程序（汇编语言）
  - 可独立运行于x86架构的主机（无操作系统）
  - 运行后可在屏幕上打印"Hello, DTOS!"

- 实现思路

  - 将关键寄存器的值设置为0（mov ax, 0）
  - 定义需要打印的数据（db "Hello, DTOS!"）
  - 打印预定义好的字符数据（int 0x10）

- 汇编小贴士：

  - mov：赋值操作，将右操作数赋值给左操作数

    - ```asm
      mov ax, 0	;将0赋值给ax寄存器
      ```

  - int：触发中断

    - ```asm
      int 0x10	;触发0x10中断，对屏幕进行操作
      ```

  - hlt：停止运行，CPU进入暂停状态，不执行任何操作

    - ```asm
      hlt			;使程序进入睡眠状态
      ```

  - 汇编中地址的访问方式：段地址：段内偏移地址

    - ```asm
      mov byte[0xb800:0x01], 0x07	;0xb800:0x01 -> 0xb8000 + 0x01 ->赋值操作
      ```

  - 标签

    - 用于标识后续指令的地址（等同于C语言中的goto）

  - `$` vs `$$`

    - `$` 表示当前指令的地址
    - `$$`表示当前汇编指令的起始地址

- 中断调用和函数调用的区别

  - ![lecture_2_1](./fig_src/lecture_2/lecture_2_1.png)

- 编程实验

- 如何验证编写的主引导程序？

- 解决方案设计

  - 将汇编源码编译为二进制机器码（nasm）

  - 创建虚拟盘（bximage）

  - 将二进制代码写入虚拟盘起始位置（dd）

  - 在虚拟机中将虚拟盘作为启动盘执行（vmware）

- 实验原材料

  - nasm

    - ```shell
      $ nasm boot.asm -o boot.bin
      ```

  - bximage

    - ```shell
      $ bximage a.img -q -fd -size=1.44
      ```

  - dd

    - ```shell
      $dd if=boot.bin of=a.img bs=512 count=1 conv=notrunc
      ```

- 编程实验：

- ```asm
  org 0x7c00
  
  start:
  	mov ax, cs
  	mov ss, ax
  	mov ds, ax
  	mov es, ax
  	
  	mov si, msg
  	
  print:
  	mov al, [si]
  	add si, 1
  	cmp al, 0x00
  	je last
  	mov ah, 0x0e
      mov bx, 0x0f
  	int 0x10
  	jmp print
  
  last:
  	hlt
  	jmp last
  
  msg:
  	db 0x0a, 0x0a
  	db "Hello, DTOS!"
  	db 0x0a, 0x0a
  	times 510-($-$$) db 0x00
  	db 0x55, 0xaa
  
  ```

- 小结

  - 主引导程序的代码量不能超过512字节
  - 主引导程序需要使用汇编语言开发
  - 主引导程序中可以通过BIOS中断使用硬件功能
  - 主引导程序运行于实模式（地址都是实际的物理地址）

## 第三课：调试环境的搭建

- 
